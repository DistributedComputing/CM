% SPDX-License-Identifier: CC-BY-SA-4.0
% Author: Matthieu Perrin
% Part: 
% Section: 
% Sub-section: 
% Frame: 

\begingroup

\tikzset{
  output adopt/.style={
    rectangle,
    minimum height=2.5mm,
    anchor=north,
    align=center,
    draw highlighted,
    text highlighted,
    outer sep=0pt,
    inner sep=1pt,
    text width=6mm,
  },
  algo value/.style={
    rectangle,
    minimum height=2.5mm,
    anchor=north,
    align=center,
    draw highlighted,
    fill highlighted,
    outer sep=0pt,
    inner sep=1pt,
  },
  output/.style={
    algo value,
    text width=6mm,
  },
  output grey/.style={
    draw,
    fill=black!20,
    output,
  },
  output graph/.style={
    rectangle,
    rounded corners,
    outer sep=0pt,
    inner sep=1pt,
    minimum width=12mm,
    minimum height=4mm,
    draw,
  },
}

\SetKwFunction{Decide}{decide}
\SetKwFunction{Propose}{propose}
\SetKwFunction{Filter}{filter}
\SetKwFunction{Choose}{choose}
\SetKwData{AAC}{aac}

\newcommand{\Abort}{\textsc{Abort}}
\newcommand{\Adopt}{\textsc{Adopt}}
\newcommand{\Commit}{\textsc{Commit}}


\begin{frame}{Un algorithme toujours sûr}

  \on[top=-3mm]{
    \begin{algorithm}[H]
      \lSVariables{}{
        $\AAC[0, ...]$; \tcp*[f]{tableau d'objets AAC}
      }
      \Method{$\Propose(v)$}{
        \For{$\mathit{round}$ \From $0$ \To $\infty$}{
          \Switch{$\AAC[\mathit{round}].\Propose(v)$}{
            \lCase{$\Commit(w)$}{$\Decide(w)$; \tcp*[f]{diffuse $w$ puis termine}}
            \lCase{$\Adopt(w)$}{$v \leftarrow w$; \tcp*[f]{adopte $w$}}
            \lCase{$\Abort$}{$v \leftarrow \Choose()$;\tcp*[f]{choisit une valeur déjà vue}}
          }
        }
      }
    \end{algorithm}
  }

  \obBlock<1>[anchor=north, y=7mm]{Une ronde d'exécution pour 3 processus}{}
  
  \ob<1>[y=-24mm]{
    \begin{tikzpicture}[x=8mm, y=12mm]
      \tiny
      \node[alert,   output] (I11) at (1,1)       {$\bullet$} ;
      \node[alert,   output] (I12) at (I11.south) {$\bullet$} ;
      \node[alert,   output] (I13) at (I12.south) {$\bullet$} ;
      \node[alert,   output] (I21) at (5,1)       {$\bullet$} ;
      \node[alert,   output] (I22) at (I21.south) {$\bullet$} ;
      \node[example, output] (I23) at (I22.south) {$\bullet$} ;
      \node[alert,   output] (I31) at (9,1)       {$\bullet$} ;
      \node[example, output] (I32) at (I31.south) {$\bullet$} ;
      \node[example, output] (I33) at (I32.south) {$\bullet$} ;
      \node[example, output] (I41) at (13,1)      {$\bullet$} ;
      \node[example, output] (I42) at (I41.south) {$\bullet$} ;
      \node[example, output] (I43) at (I42.south) {$\bullet$} ;
      
      \node[alert,   output]   (F011) at (1,0)        {\Commit} ;
      \node[alert,   output]   (F012) at (F011.south) {\Commit} ;
      \node[alert,   output]   (F013) at (F012.south) {\Commit} ;
      \node[alert,   output]   (F021) at (2,0)        {\Commit} ;
      \node[alert,   output]   (F022) at (F021.south) {\Commit} ;
      \node[alert,   output adopt]   (F023) at (F022.south) {\Adopt} ;
      \node[alert,   output]   (F031) at (3,0)        {\Commit} ;
      \node[alert,   output adopt]   (F032) at (F031.south) {\Adopt} ;
      \node[alert,   output adopt]   (F033) at (F032.south) {\Adopt} ;
      \node[alert,   output adopt]   (F041) at (4,0)        {\Adopt} ;
      \node[alert,   output adopt]   (F042) at (F041.south) {\Adopt} ;
      \node[alert,   output adopt]   (F043) at (F042.south) {\Adopt} ;
      \node[alert,   output adopt]   (F051) at (5,0)        {\Adopt} ;
      \node[alert,   output adopt]   (F052) at (F051.south) {\Adopt} ;
      \node[output grey]             (F053) at (F052.south) {\Abort} ;
      \node[alert,   output adopt]   (F061) at (6,0)        {\Adopt} ;
      \node[output grey]             (F062) at (F061.south) {\Abort} ;
      \node[output grey]             (F063) at (F062.south) {\Abort} ;
      \node[output grey]             (F071) at (7,0)        {\Abort} ;
      \node[output grey]             (F072) at (F071.south) {\Abort} ;
      \node[output grey]             (F073) at (F072.south) {\Abort} ;
      \node[output grey]             (F081) at (8,0)        {\Abort} ;
      \node[output grey]             (F082) at (F081.south) {\Abort} ;
      \node[example,   output adopt] (F083) at (F082.south) {\Adopt} ;
      \node[output grey]             (F091) at (9,0)        {\Abort} ;
      \node[example,   output adopt] (F092) at (F091.south) {\Adopt} ;
      \node[example,   output adopt] (F093) at (F092.south) {\Adopt} ;
      \node[example,   output adopt] (F101) at (10,0)       {\Adopt} ;
      \node[example,   output adopt] (F102) at (F101.south) {\Adopt} ;
      \node[example,   output adopt] (F103) at (F102.south) {\Adopt} ;
      \node[example,   output adopt] (F111) at (11,0)       {\Adopt} ;
      \node[example,   output adopt] (F112) at (F111.south) {\Adopt} ;
      \node[example, output]   (F113) at (F112.south) {\Commit} ;
      \node[example,   output adopt] (F121) at (12,0)       {\Adopt} ;
      \node[example, output]   (F122) at (F121.south) {\Commit} ;
      \node[example, output]   (F123) at (F122.south) {\Commit} ;
      \node[example, output]   (F131) at (13,0)       {\Commit} ;
      \node[example, output]   (F132) at (F131.south) {\Commit} ;
      \node[example, output]   (F133) at (F132.south) {\Commit} ;

      \node[alert,   output] (IB11) at (4,-1)      {$\bullet$} ;
      \node[alert,   output] (IB12) at (IB11.south) {$\bullet$} ;
      \node[alert,   output] (IB13) at (IB12.south) {$\bullet$} ;
      \node[alert,   output] (IB21) at (6,-1)      {$\bullet$} ;
      \node[alert,   output] (IB22) at (IB21.south) {$\bullet$} ;
      \node[example, output] (IB23) at (IB22.south) {$\bullet$} ;
      \node[alert,   output] (IB31) at (8,-1)      {$\bullet$} ;
      \node[example, output] (IB32) at (IB31.south) {$\bullet$} ;
      \node[example, output] (IB33) at (IB32.south) {$\bullet$} ;
      \node[example, output] (IB41) at (10,-1)     {$\bullet$} ;
      \node[example, output] (IB42) at (IB41.south) {$\bullet$} ;
      \node[example, output] (IB43) at (IB42.south) {$\bullet$} ;

      \path[-latex] (I13) edge (F011);
      \path[-latex] (I23) edge (F021);
      \path[-latex] (I23) edge (F031);
      \path[-latex] (I23) edge (F041);
      \path[-latex] (I23) edge (F041);
      \path[-latex] (I23) edge (F051);
      \path[-latex] (I23) edge (F061);
      \path[-latex] (I23) edge (F071);
      \path[-latex] (I33) edge (F071);
      \path[-latex] (I33) edge (F081);
      \path[-latex] (I33) edge (F091);
      \path[-latex] (I33) edge (F101);
      \path[-latex] (I33) edge (F101);
      \path[-latex] (I33) edge (F111);
      \path[-latex] (I33) edge (F121);
      \path[-latex] (I43) edge (F131);

      \path[-latex] (F043) edge (IB11);
      \path[-latex] (F053) edge (IB11);
      \path[-latex] (F053) edge (IB21);
      \path[-latex] (F063) edge (IB11);
      \path[-latex] (F063) edge (IB21);
      \path[-latex] (F063) edge (IB31);

      \path[-latex] (F073) edge (IB11);
      \path[-latex] (F073) edge (IB21);
      \path[-latex] (F073) edge (IB31);
      \path[-latex] (F073) edge (IB41);

      \path[-latex] (F083) edge (IB21);
      \path[-latex] (F083) edge (IB31);
      \path[-latex] (F083) edge (IB41);
      \path[-latex] (F093) edge (IB31);
      \path[-latex] (F093) edge (IB41);
      \path[-latex] (F103) edge (IB41);

      \normalsize
      \path[brace] (F033.south east) edge[brace] node{$\alert{\Decide(\bullet)}$} (F013.south west);
      \path[brace] (F133.south east) edge[brace] node{$\example{\Decide(\bullet)}$} (F113.south west);
      
    \end{tikzpicture}
  }
  
  \onBlock<2>[anchor=north, y=7mm]{Garantie de sûreté, pas de vivacité}{
    \begin{description}[Validité :]
    \item[Validité :] Toute valeur décidée a été proposée
      \begin{itemize}
      \item l'algorithme n'invente pas de valeur
      \end{itemize}
    \item[Accord :] Au plus une valeur est décidée
      \begin{itemize}
      \item si $v$ est décidée, les processus ont $\Adopt(v)$ ou $\Commit(v)$
      \item terminaison garantie à la ronde suivante par conservation
      \end{itemize}
    \item[Terminaison :] Aucune garantie déterministe possible (FLP)
      \begin{itemize}
      \item Choix d'une valeur déterministe (valeur minimale, la plus vue...)
      \item Exécutions pathologiques même pour un ordonnanceur réaliste
      \end{itemize}
    \end{description}
  }

\end{frame}

\endgroup
\endinput

