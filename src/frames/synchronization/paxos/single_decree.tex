% SPDX-License-Identifier: CC-BY-SA-4.0
% Author: Matthieu Perrin
% Part: 
% Section: 
% Sub-section: 
% Frame: 

\begingroup

\SetKwFunction{Leader}{leader}
\SetKwFunction{Propose}{propose}

\begin{frame}[fragile]{L'algorithme Single-decree Paxos}

  \on[top=-3mm]{\small
    \begin{algorithm}[H]
      \lLVariables{}{
        \Alertb<1,5>{$\mathit{decided}_i \leftarrow \bot$};
        \Structureb<2>{$\mathit{ballot}_i \leftarrow \langle 0, 0 \rangle $};
        \Exampleb<3-5>{$\mathit{val}_i \leftarrow \bot$}
      }
      \Operation{$\Propose(v)$}{
        \lIf{$\mathit{val}_i = \bot$}{\Exampleb<5>{$\mathit{val}_i \leftarrow v$}}
        \While{\Alertb<1,5>{$\mathit{decided}_i = \bot$}}{
          \If{\Alertb<1,6>{$leader() = i$}}{
            \Structureb<2>{\Let $t$ \St $\langle t, i\rangle >  ballot_i$}\;
            \Structureb<3-4>{\SBroadcast{mutual} $\textsc{begin}(t)$}\;
            \lIf{\Structureb<3-4>{$\langle t, i\rangle = ballot_i$}}{ 
              \Exampleb<3-4>{\SBroadcast{mutual} $\textsc{voted}(t, \Exampleb<5>{val_i})$}%
            }
            \lIf{\Structureb<3-4>{$\langle t, i\rangle = ballot_i$}}{ 
              \Alertb<1,4>{\Broadcast{rb} $\textsc{decide}(\Exampleb<5>{val_i})$}%
            }
          }
        }
        \Alertb<1,5>{\Return $\mathit{decided}_i$}\;
      }
      \When{\Structureb<3-4>{\Deliver{mutual} $\textsc{begin}(t)$ \From $p_j$}}{
        \lIf{\Structureb<3-4>{$\langle t, j\rangle \ge \mathit{ballot}_i$}}{
          \Structureb<3-4>{$\mathit{ballot}_i \leftarrow \langle t, j \rangle $}%
        }
      }
      \When{\Exampleb<3-4>{\Deliver{mutual} $\textsc{voted}(t,v)$ \From $p_j$}}{
        \lIf{\Structureb<3-4>{$\langle t, j\rangle \ge \mathit{ballot}_i$}}{
          \Structureb<3-4>{$\mathit{ballot}_i \leftarrow \langle t, j \rangle $};
          \Exampleb<3-5>{$\mathit{val}_i \leftarrow v$}%
        }
      }
      \When{\Alertb<1>{\Deliver{rb} $\textsc{decide}(v)$ \From $p_j$}}{
        \Alertb<1,5>{$\mathit{decided}_i \leftarrow v$}\;
      }
    \end{algorithm}
  }

  \obAlertBlock<1>[anchor=north, y=-20mm]{Un algorithme centralisé}{
    \begin{itemize}
    \item La valeur décidée est choisie par un leader
    \end{itemize}
  }

  \obAlertBlock<2>[anchor=north, y=-20mm]{Système de rondes asynchrones}{
    \begin{description}[ballot number :]
    \item[ballot number :] $\langle 0, 1 \rangle ; ... ; \langle 0, n \rangle ; \langle 1, 1 \rangle ; ... ; \langle 1, n \rangle ; \langle 2, 1 \rangle ; ... ; \langle 2, n \rangle ; ...$
    \item[leader :] Seul $p_j$ peut être \emph{leader} pour $\langle \_, j \rangle$
    \end{description}
  }
  
  \obAlertBlock<3>[anchor=north, y=-20mm]{Chaque ronde est divisée en deux phases}{
    \begin{description}[\textsc{voted} :]
    \item[\alert{\textsc{begin} :}] Arrête les rondes précédentes et récupère leur valeur
    \item[\example{\textsc{voted} :}] Transmet la valeur aux rondes suivantes
    \end{description}
  }

  \onAlertBlock<4>[anchor=north, y=-20mm]{Correction : accord (par l'absurde)}{}

  \on<4>[y=-10mm, right=35mm]{\small
    Soient $\langle t_i, i \rangle < \langle t_j, j \rangle$\\
    les deux plus petits \\ \emph{ballot numbers} tels que :
    \begin{itemize}
    \item $p_i$ envoie $\textsc{decide}(v_i)$
    \item $p_j$ envoie $\textsc{decide}(v_j)$
    \end{itemize}
    avec $v_i \neq v_j$. \\
    D'après mutual ordering :
  }

  \on<4>[bottom=-2mm, x=.25\textwidth]{
    \begin{tikzpicture}[anchor=mid,y=5mm, x=8mm]
      \draw[->] (0,1) node[left]{$p_i$} -- (5,1);
      \draw[->] (0,0) node[left]{$p_j$} -- (5,0);
      
      \node[example]   at (1,1) {$\bullet$}; \node[above left, example]   at (1,1) {\scriptsize $\textsc{voted}(t_i, v_i)$};
      \node[alert]     at (1,0) {$\bullet$}; \node[below left, alert]     at (1,0) {\scriptsize $\textsc{begin}(t_j)$};
      \node[structure] at (4,0) {$\bullet$}; \node[above, structure] at (4,0) {\scriptsize $\textsc{decide}(v_i)$};

      \path[-latex,example  ] (1,1) edge[bend left]  (2,1);
      \path[-latex,example  ] (1,1) edge             (2,0);
      \path[-latex,alert    ] (1,0) edge[bend right] (3,0);
      \path[-latex,structure] (4,0) edge +(.5,-.5);
    \end{tikzpicture}
  }

  \on<4>[bottom=-2mm, x=-.25\textwidth]{
    \begin{tikzpicture}[anchor=mid,y=5mm, x=8mm]
      \draw[->] (0,1) node[left]{$p_i$} -- (5,1);
      \draw[->] (0,0) node[left]{$p_j$} -- (5,0);
      
      \node[example]   at (1,1) {$\bullet$}; \node[above left, example]   at (1,1) {\scriptsize $\textsc{voted}(t_i, v_i)$};
      \node[alert]     at (1,0) {$\bullet$}; \node[below left, alert]     at (1,0) {\scriptsize $\textsc{begin}(t_j)$};
      \node[structure] at (4,1) {$x$}; \node[below, structure] at (4,1) {\scriptsize $\textsc{decide}(v_i)$};

      \path[-latex,example  ] (1,1) edge[bend left]  (3,1);
      \path[-latex,alert    ] (1,0) edge             (2,1);
      \path[-latex,alert    ] (1,0) edge[bend right] (2,0);
    \end{tikzpicture}
  }

  \obAlertBlock<5>[anchor=north, y=-20mm]{Correction : validité}{
    \begin{itemize}
    \item\vspace{-1mm} Seules $\bot$ et des valeurs proposées sont écrites dans $\mathit{decided}_i$ et $\mathit{val}_i$
    \item\vspace{-1mm} Seules des valeurs proposées sont envoyées par $\textsc{voted}$ et $\textsc{decide}$
    \item\vspace{-1mm} Lors de la décision, $\mathit{decided}_i\neq\bot$
    \end{itemize}
  }

  \obAlertBlock<6>[anchor=north, y=-20mm]{Correction : terminaison}{
    \begin{itemize}
    \item Si un seul leader correct, il termine sa ronde et envoie $\textsc{decide}(val_i)$
    \item Un jour, un leader correct est élu...
    \end{itemize}
  }
  
\end{frame}

\endgroup
\endinput
